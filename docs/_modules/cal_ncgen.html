
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>cal_ncgen &#8212; Creation/updates of nc files for FAAM calibration data 0.2 documentation</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Creation/updates of nc files for FAAM calibration data 0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cal_ncgen</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script for creating FAAM calibration netCDF files.</span>

<span class="sd">.. code-block:: console</span>

<span class="sd">    $ python3 cal_ncgen.py SEA-WCM2000.cdl</span>

<span class="sd">creates a netCDF4 file, ``SEA-WCM2000.nc`` from the cdl source file. To</span>
<span class="sd">update variables in the netCDF directly from the command line;</span>

<span class="sd">.. code-block:: console</span>

<span class="sd">    $ python3 cal_ncgen.py SEA-WCM2000.nc -u time 700 800</span>
<span class="sd">      -u applies_to C150- C180- -u TWC/r100 31.4473 31.5585</span>
<span class="sd">      -u TWC/dtdr 33.9276 34.0387 --user &#39;Graeme Nott &lt;graeme.nott@faam.ac.uk&gt;&#39;</span>
<span class="sd">      --hist \&lt;now\&gt;\ Artificial\ update\ 1 &#39;&lt;today&gt; Artificial update 2&#39;</span>

<span class="sd">where the nc file is read in and four parameters are updated. Two entries</span>
<span class="sd">are appended to the global variables ``time`` and ``applies_to``, and to the</span>
<span class="sd">TWC group variables ``TWC/r100`` and ``TWC/dtdr``. The same username is</span>
<span class="sd">appended to the ``username`` global attribute for both entries. Different</span>
<span class="sd">history strings are appended to the global ``history`` attribute however (note</span>
<span class="sd">the two different ways to escape history strings) with ``&lt;now&gt;`` and ``&lt;today&gt;``</span>
<span class="sd">being converted to the current date.</span>

<span class="sd">An existing calibration netCDF may have values appended to to it from a cdl or</span>
<span class="sd">nc file with;</span>

<span class="sd">.. code-block:: console</span>

<span class="sd">    $ python3 cal_ncgen.py SEA-WCM2000_cal_20180810.nc SEA-WCM2000_20190805.cdl</span>

<span class="sd">Explicitly giving a different output filename with the --output argument will</span>
<span class="sd">leave WCM2000_cal_20180810.nc unaltered and create a new calibration netCDF;</span>

<span class="sd">.. code-block:: console</span>

<span class="sd">    $ python3 cal_ncgen.py SEA-WCM2000_cal_20180810.nc SEA-WCM2000_20190805.cdl</span>
<span class="sd">      --output WCM2000_cal_2018-19.nc</span>

<span class="sd">It is possible to update variables using one or more external files. This</span>
<span class="sd">requires a custom parser to be part of the instrument processor class so that</span>
<span class="sd">these files can be read and injested. A single external file may be added to an</span>
<span class="sd">existing calibration netCDF file with;</span>

<span class="sd">.. code-block:: console</span>

<span class="sd">    $ python3 cal_ncgen.py PCASP_faam_20170701_v001_r000_cal.nc -u time 20170919</span>
<span class="sd">      -u applies_to C027-C055 -u parsefile testing/data/20170919_P1_cal_results_cs.csv</span>

<span class="sd">Additional metadata associated with the text file</span>
<span class="sd">`testing/data/20170919_P1_cal_results_cs.csv` is given with `-u` arguments. The</span>
<span class="sd">special --update key `parsefile` indicates that the following value needs to be</span>
<span class="sd">parsed with the instrument-specific parser method.</span>

<span class="sd">It is also possible to add multiple external calibration files at the same time</span>
<span class="sd">as the associated metadata with an external configuration file. This file uses</span>
<span class="sd">the standard ascii format that is parsed with the `configparser</span>
<span class="sd">&lt;https://docs.python.org/3.7/library/configparser.html&gt;`_ package. So if for</span>
<span class="sd">example the config file `PCASP1_CLARIFY_cals.cfg` contained;</span>

<span class="sd">.. code-block::</span>

<span class="sd">    [pre-CLARIFY]</span>
<span class="sd">    _group = bin_cal</span>
<span class="sd">    time = 20170701</span>
<span class="sd">    applied_to = C027-</span>
<span class="sd">    user = Graeme Nott</span>
<span class="sd">    traceability = List of PSL lot number information</span>
<span class="sd">    comments = After realignment of inlet jet</span>
<span class="sd">    cal_flag = 0</span>
<span class="sd">    _parsefile = testing/data/20170801_P1_cal_results_cs.csv</span>

<span class="sd">    [post-CLARIFY]</span>
<span class="sd">    _group = bin_cal</span>
<span class="sd">    time = 20170919</span>
<span class="sd">    applied_to = C027-C055</span>
<span class="sd">    user = Graeme Nott</span>
<span class="sd">    traceability = List of PSL lot number information</span>
<span class="sd">    cal_flag = 0</span>
<span class="sd">    _parsefile = testing/data/20170919_P1_cal_results_cs.csv</span>

<span class="sd">this could be inserted into an existing netCDF file that has been created from</span>
<span class="sd">the PCASP1 template cdl file as follows;</span>

<span class="sd">.. code-block:: console</span>

<span class="sd">    $ python3 cal_ncgen.py PCASP1_cal.cdl -u parsefile PCASP1_CLARIFY_cals.cfg</span>
<span class="sd">      -o PCASP_faam_20170701_v001_r000_cal.nc</span>

<span class="sd">Note that such a config file must have a recognisable format and the `.cfg.` or</span>
<span class="sd">`.config` extension to ensure that the instrument parser is not invoked on the</span>
<span class="sd">config file directly. The *special* options in each section that start with</span>
<span class="sd">an ``_`` are not treated as netCDF attributes or variables but are used to</span>
<span class="sd">assist in the processing of the options.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>

<span class="kn">import</span> <span class="nn">pdb</span>

<span class="kn">import</span> <span class="nn">cal_proc</span>
<span class="kn">from</span> <span class="nn">cal_proc</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cal_nc</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1"># Default directories where cdl file/s may be stored</span>
<span class="c1"># Searched in order</span>
<span class="n">default_cdl_dir</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;cal_cdl&#39;</span><span class="p">]</span>

<span class="c1"># Directory where temporary files are stored</span>
<span class="n">default_tmp_dir</span> <span class="o">=</span> <span class="s1">&#39;./tmp&#39;</span>


<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="call"><a class="viewcode-back" href="../_source/cal_ncgen.html#cal_ncgen.call">[docs]</a><span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function for cal_ncgen</span>

<span class="sd">    :param infile: One or more cdl files. If multiple files then concat,</span>
<span class="sd">        if single cdl then ncgen to nc.</span>
<span class="sd">    :type infile: list</span>
<span class="sd">    :param args: Arguments for adding to cdl file</span>
<span class="sd">    :type args: Dictionary</span>
<span class="sd">    :returns: None</span>

<span class="sd">    :How this function works::</span>

<span class="sd">        * .. TODO::</span>
<span class="sd">             concatenate multiple cdl input files</span>
<span class="sd">        * If infile is cdl then create nc by calling ``ncgen``.</span>
<span class="sd">          If no other arguments for nc then finish</span>
<span class="sd">        * open nc file as ``root``</span>
<span class="sd">        * determine instrument to operate on from nc or args[&#39;instr&#39;]</span>
<span class="sd">        * Instantiate instrument class</span>
<span class="sd">        * Write or append data to variables</span>
<span class="sd">        * write nc</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">os.path</span>

    <span class="c1"># Create absolute paths for infile/s</span>
    <span class="c1"># temporarily create a set to get rid of dups</span>
    <span class="n">abs_infile_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">))</span> \
                   <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">infile</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">default_cdl_dir</span>\
                   <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">))]))</span>

    <span class="c1"># abs_infile_ = []</span>
    <span class="c1"># for f_ in infile:</span>
    <span class="c1">#     for d_ in default_cdl_dir:</span>
    <span class="c1">#         if os.path.isfile(os.path.join(d_,f_)):</span>
    <span class="c1">#             abs_infile_.append(os.path.abspath(os.path.join(d_,f_)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abs_infile_</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Given input file not found:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f_</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f__</span><span class="p">)</span> <span class="k">for</span> <span class="n">f__</span> <span class="ow">in</span> <span class="n">abs_infile_</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f_</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Remove any duplicate files</span>
    <span class="n">abs_infile</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f_</span> <span class="ow">in</span> <span class="n">abs_infile_</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">a_</span><span class="p">,</span><span class="n">f_</span><span class="p">)</span> <span class="k">for</span> <span class="n">a_</span> <span class="ow">in</span> <span class="n">abs_infile</span><span class="p">]):</span>
            <span class="n">abs_infile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abs_infile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Are no valid input files</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">No valid input files have been given&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Split input files into nc and cdl lists</span>
    <span class="n">nc_infile</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_</span> <span class="k">for</span> <span class="n">f_</span> <span class="ow">in</span> <span class="n">abs_infile</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f_</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.nc&#39;</span><span class="p">]</span>
    <span class="n">cdl_infile</span> <span class="o">=</span><span class="p">[</span><span class="n">f_</span> <span class="k">for</span> <span class="n">f_</span> <span class="ow">in</span> <span class="n">abs_infile</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f_</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.cdl&#39;</span><span class="p">]</span>

    <span class="c1"># Find &#39;master&#39; input file on which to build</span>
    <span class="c1"># Note that this shall always be the first netCDF file if one is provided.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">master_infile</span> <span class="o">=</span> <span class="n">nc_infile</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="c1"># No nc files provided</span>
        <span class="n">master_infile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">cdl_infile</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
        <span class="n">run_ncgen</span><span class="p">(</span><span class="n">cdl_infile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">master_infile</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">cdl_infile</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Determine filename of output file</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;outfile&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;outfile&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;outfile&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">master_infile</span>

    <span class="c1"># Read in all cdl files and convert to netCDF with temporary filenames</span>
    <span class="n">tmpfile</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cdl_infile</span><span class="p">):</span>
        <span class="c1">#tmpfile.append(tempfile.TemporaryFile(dir=os.path.dirname(f_)))</span>
        <span class="n">tmpfile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_tmp.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">default_tmp_dir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                                                 <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Run cal_nc.nc_func.ncgen to produce netCDF-4 format file</span>
        <span class="n">run_ncgen</span><span class="p">(</span><span class="n">f_</span><span class="p">,</span><span class="n">tmpfile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Make sure master is pointing to a nc file</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">master_infile</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.nc&#39;</span><span class="p">:</span>
        <span class="c1"># If master_infile is a cdl then make master the corresponding nc file</span>
        <span class="n">master_infile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">master_infile</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.nc&#39;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">master_infile</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">tmp_outfile</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">v_</span><span class="o">==</span><span class="kc">None</span> <span class="k">for</span> <span class="n">k_</span><span class="p">,</span><span class="n">v_</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k_</span> <span class="o">!=</span> <span class="s1">&#39;outfile&#39;</span><span class="p">])</span> \
       <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">abs_infile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># No arguments for single file so can return as outfile</span>

        <span class="k">if</span> <span class="n">master_infile</span> <span class="o">!=</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">master_infile</span><span class="p">,</span><span class="n">outfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">outfile</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Written: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Written: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">outfile</span><span class="p">)))</span>
        <span class="k">return</span>

    <span class="c1"># Restructure update args into list of dictionaries.</span>
    <span class="c1"># If the same update key called multiple times then make value a list</span>
    <span class="n">updates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">u_</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;update_arg&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">u_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">u_</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">u_</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">updates</span><span class="p">[</span><span class="n">u_</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">u_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1">### Process ########################################################</span>
    <span class="n">proc_rtn</span><span class="p">,</span> <span class="n">proc_err</span> <span class="o">=</span> <span class="n">process_nc</span><span class="p">(</span><span class="n">master_infile</span><span class="p">,</span>
                                    <span class="n">nc_infile</span> <span class="o">+</span> <span class="n">tmpfile</span><span class="p">,</span>
                                    <span class="n">out_nc</span> <span class="o">=</span> <span class="n">outfile</span><span class="p">,</span>
                                    <span class="n">instr</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;instr&#39;</span><span class="p">],</span>
                                    <span class="n">updates</span><span class="o">=</span><span class="n">updates</span><span class="p">)</span>



    <span class="c1"># Delete any temporary files</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tmpfile</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">proc_rtn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Error occured in process_nc</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">proc_err</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">return</span></div>

    <span class="c1"># pdb.set_trace()</span>

    <span class="c1"># # Create a instrument processor from the master nc file. This file remains</span>
    <span class="c1"># # open until explicitly closed.</span>
    <span class="c1"># master_ds, _ = read_nc(master_infile)</span>

    <span class="c1"># # Create list of all additional nc files</span>
    <span class="c1"># aux_nc = nc_infile[1:] + tmp_outfile</span>

    <span class="c1"># # Obtain intrument from master or, if provided, from user arguments</span>
    <span class="c1"># if args[&#39;instr&#39;] is None:</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         instr = master_ds.getncattr(&#39;instr&#39;)</span>
    <span class="c1">#     except AttributeError:</span>
    <span class="c1">#         print(&#39;No instrument name given in master file.&#39;)</span>
    <span class="c1">#         print(&#39;Use --update instr instrument argument.&#39;)</span>
    <span class="c1">#         return</span>
    <span class="c1"># else:</span>
    <span class="c1">#     # User-given arguement overrides instrument name in input files</span>
    <span class="c1">#     instr = args[&#39;instr&#39;]</span>

    <span class="c1"># # Obtain appropriate instrument processing class</span>
    <span class="c1"># instr_class = cal_proc.proc_map(instr)</span>

    <span class="c1"># try:</span>
    <span class="c1">#     # Initialise the nc object</span>
    <span class="c1">#     master = instr_class(master_ds)</span>
    <span class="c1"># except Exception as err:</span>
    <span class="c1">#     print(&#39;Instrument processing class not found: {}\n&#39;.format(instr))</span>
    <span class="c1">#     return</span>

    <span class="c1"># # Print out instrument processor help if required</span>
    <span class="c1"># try:</span>
    <span class="c1">#     if &#39;help&#39; in args[&#39;update_arg&#39;]:</span>
    <span class="c1">#         print(master)</span>
    <span class="c1">#         return</span>
    <span class="c1"># except TypeError:</span>
    <span class="c1">#     # eg if args[&#39;update_arg&#39;] is None</span>
    <span class="c1">#     pass</span>


    <span class="c1"># pdb.set_trace()</span>
    <span class="c1"># combine_datasets(master.ds,aux_ds[0],master.ds)</span>


    <span class="c1"># # Want to apply history and user attributes for each update so make</span>
    <span class="c1"># # sure are correct length.</span>
    <span class="c1"># # The username is the same for all updates</span>
    <span class="c1"># if args[&#39;user&#39;] == None:</span>
    <span class="c1">#     user = None</span>
    <span class="c1"># else:</span>
    <span class="c1">#     user = [&#39; &#39;.join(args[&#39;user&#39;])] * modal_len</span>

    <span class="c1"># if args[&#39;hist&#39;] == None:</span>
    <span class="c1">#     history = None</span>
    <span class="c1"># else:</span>
    <span class="c1">#     if len(args[&#39;hist&#39;]) &gt; modal_len:</span>
    <span class="c1">#         history = args[&#39;hist&#39;][:modal_len]</span>
    <span class="c1">#         discard_hist = args[&#39;hist&#39;][modal_len:]</span>
    <span class="c1">#     elif len(args[&#39;hist&#39;]) != modal_len:</span>
    <span class="c1">#         history = [args[&#39;hist&#39;][0]] * modal_len</span>
    <span class="c1">#         discard_hist = args[&#39;hist&#39;][1:]</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         history = args[&#39;hist&#39;]</span>
    <span class="c1">#         discard_hist = []</span>

    <span class="c1">#     if discard_hist != []:</span>
    <span class="c1">#         print(&#39;\nUpdate history argument is incorrect length, &#39;</span>
    <span class="c1">#               &#39;discarding entries:&#39;)</span>
    <span class="c1">#         print(&#39; &#39;,&#39;\n  &#39;.join(discard_hist))</span>
    <span class="c1">#         print()</span>

    <span class="c1"># # Update the variables/attributes</span>
    <span class="c1"># nc.update(updates)</span>

    <span class="c1"># # Update the history and username attributes</span>
    <span class="c1"># nc.update_hist(history)</span>
    <span class="c1"># nc.update_user(user)</span>

<span class="c1"># root closed</span>


<span class="c1"># ----------------------------------------------------------------------</span>
<span class="c1"># ----------------------------------------------------------------------</span>
<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="c1"># Define commandline options</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(prog)s</span><span class="s1"> files [options]&#39;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;version: </span><span class="si">{v}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">cal_proc</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Script to assist in the creation of calibration &#39;</span> <span class="o">+</span>\
                   <span class="s1">&#39;netCDF files.</span><span class="se">\n</span><span class="s1"> </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">))</span>
    <span class="n">epilog</span> <span class="o">=</span> <span class="vm">__doc__</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span>
                <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
                <span class="n">epilog</span><span class="o">=</span><span class="n">epilog</span><span class="p">)</span>

    <span class="c1"># Mandatory argument</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span>
                        <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Input cdl or nc file/s. If one or more cdl files &#39;</span>
                        <span class="s1">&#39;then a new calibration netCDF file shall be created &#39;</span>
                        <span class="s1">&#39;using the (concatenated if possible) cdl as a template. &#39;</span>
                        <span class="s1">&#39;If an existing nc file is given then new calibration &#39;</span>
                        <span class="s1">&#39;data shall be appended to the variables in that file. &#39;</span>
                        <span class="s1">&#39;This data is provided in additional cdf/nc files or &#39;</span>
                        <span class="s1">&#39;as --update argumenmts. The first nc file, and if none &#39;</span>
                        <span class="s1">&#39;the first cdl file, is treated as the master and used &#39;</span>
                        <span class="s1">&#39;for output filename generation, root attributes, etc.&#39;</span><span class="p">))</span>

    <span class="c1"># Optional arguments</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--update&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span>
                        <span class="n">nargs</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;update_arg&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Space-delineated list of data parameters &#39;</span>
                        <span class="s1">&#39;as required by the specific instrument class. &#39;</span>
                        <span class="s2">&quot;&#39;--update&#39; can be given multiple times, each time &quot;</span>
                        <span class="s1">&#39;being used to update a different parameter.&#39;</span>
                        <span class="s2">&quot;Use &#39;-u help&#39; for instrument specific help.&quot;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="s1">&#39;--instr&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;instr&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Instrument class is selected based on the &#39;</span>
                        <span class="s2">&quot;&#39;instr&#39; global attribute in the input file. &quot;</span>
                        <span class="s1">&#39;If this is none-standard or uses a different &#39;</span>
                        <span class="s1">&#39;instrument class then instr can be explicitly &#39;</span>
                        <span class="s1">&#39;given with this option.&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;--output&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;outfile&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Explicitly give output path/filename of &#39;</span>
                        <span class="s1">&#39;cal-nc file. If not given then the filename is &#39;</span>
                        <span class="s1">&#39;generated based on the input cdl file. If the &#39;</span>
                        <span class="s1">&#39;input is an nc file and the filename is different &#39;</span>
                        <span class="s1">&#39;from the input a new nc file shall be created.&#39;</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--hist&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Do not auto-generate the updated history &#39;</span>
                        <span class="s1">&#39;attribute of the resultant cal-nc file. Instead the &#39;</span>
                        <span class="s1">&#39;given string is appended to the global history &#39;</span>
                        <span class="s1">&#39;attribute instead. These should be a space-delineated &#39;</span>
                        <span class="s1">&#39;series of dates and comments, spaces in each entry &#39;</span>
                        <span class="s1">&#39;must be enclosed in quotes or escaped. There should &#39;</span>
                        <span class="s1">&#39;be one history entry for each --update, if not then &#39;</span>
                        <span class="s1">&#39;the same history shall be attached to all updates.&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--user&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Do not auto-generate the updated username &#39;</span>
                        <span class="s1">&#39;attribute of the resultant cal-nc file. Instead the &#39;</span>
                        <span class="s1">&#39;given string is appended to the global username &#39;</span>
                        <span class="s1">&#39;attribute instead (should be space-seperated &#39;</span>
                        <span class="s1">&#39;user and &lt;email&gt;).&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--version&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;version&#39;</span><span class="p">,</span>
                        <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Display program version number.&#39;</span><span class="p">)</span>


    <span class="c1"># Process arguments and convert to dictionary ----------------------------</span>
    <span class="n">args_dict</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>
    <span class="n">opts_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">args_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">opts_dict</span><span class="p">[</span><span class="s1">&#39;update_arg&#39;</span><span class="p">]):</span>
        <span class="c1"># Replace special option arguments strings with those recognised</span>
        <span class="n">opts_dict</span><span class="p">[</span><span class="s1">&#39;update_arg&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">opts_dict</span><span class="p">[</span><span class="s1">&#39;update_arg&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;parsefile&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;_parsefile&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Welcome splash</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-----------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Calibration netCDF generation script&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----------------------------------------------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">call</span><span class="p">(</span><span class="n">args_dict</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">],</span><span class="n">opts_dict</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Done.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># EOF</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Creation/updates of nc files for FAAM calibration data 0.2 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, FAAM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.
    </div>
  </body>
</html>